pipeline {
    agent {
        node {
            label 'qa'
            customWorkspace '/mnt/projects'
        }
    }

    environment {
        COMPOSE_URL = 'https://github.com/shwetaraut815/devops-CI-CD-project.git'
        COMPOSE_DIR = 'devops-CI-CD-project/docker-compose'
    }

    stages {

        stage('Clone Docker Compose Files') {
            steps {
                sh '''
                    rm -rf *
                    git clone ${COMPOSE_URL}
                '''
            }
        }

        
        stage('Update DB Config') {
            steps {
                dir("${COMPOSE_DIR}") {
                    sh 'bash update-db-config.sh'    //give proper path
                }
            }
        }

        stage('Run Docker Compose') {
            steps {
                sh '''
                    cd ${COMPOSE_DIR}
                    sudo docker-compose down || true
                    sudo docker-compose up -d
                '''
            }
        }

       stage('DB Integration') {
    steps {
        sh '''
            echo "Waiting for MySQL to initialize..."
            sleep 15

            echo "Creating database as root..."
            docker exec mysql-db mysql -uadmin -padmin1234 -e "CREATE DATABASE IF NOT EXISTS test;"

            echo "Verifying imported tables..."
            docker exec mysql-db mysql -uadmin -padmin1234 -e "USE test; SHOW TABLES;"

        '''
    }
}

    }

    post {
        always {
            sh 'docker ps -a'
        }
    }
}
