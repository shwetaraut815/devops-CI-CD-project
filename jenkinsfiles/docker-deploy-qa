pipeline {
    agent {
        node {
            label 'qa'
            customWorkspace '/mnt/projects'
        }
    }

    environment {
        COMPOSE_URL = 'https://github.com/shwetaraut815/devops-CI-CD-project.git'
        COMPOSE_DIR = 'devops-CI-CD-project/docker-compose'
        INIT_SQL_DIR = '/mnt/projects/mysql-init'

    }

    stages {

        stage('Clone Docker Compose Files') {
            steps {
                sh '''
                    rm -rf *
                    git clone ${COMPOSE_URL}
                '''
            }
        }
        stage ("create bind mount") {
            steps{
                sh '''
            mkdir -p ${INIT_SQL_DIR}
              curl -L -o ${INIT_SQL_DIR}/init.sql \
                    https://raw.githubusercontent.com/shwetaraut815/devops-CI-CD-project/main/docker-compose/init.sql
                """
            }
        }

        
        stage('Update DB Config') {
            steps {
                dir("${COMPOSE_DIR}") {
                    sh 'bash update-db-config.sh'    //give proper path
                }
            }
        }

        stage('Run Docker Compose') {
            steps {
                sh '''
                    cd ${COMPOSE_DIR}
                    sudo docker-compose down || true
                    sudo docker-compose up -d
                '''
            }
        }
        
    }

    post {
        always {
            sh 'docker ps -a'
        }
    }
}
